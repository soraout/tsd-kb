<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>QR → EAN-13 сканер</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:16px; background:#f6f6fa; color:#111; }
    h1 { font-size:18px; margin-bottom:12px; }
    .card { background:white; border-radius:10px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:12px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    button { padding:10px 12px; border-radius:8px; border:0; background:#0b66ff; color:white; font-weight:600; cursor:pointer; }
    button.secondary { background:#6b7280; }
    select { padding:10px; border-radius:8px; border:1px solid #ccc; font-size:15px; width:100%; }
    input { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:16px; }
    #barcode { display:block; margin:12px auto; }
    .small { font-size:13px; color:#666; }
    .danger { color:#c02626; }
  </style>
  <script src="https://unpkg.com/html5-qrcode@2.4.6/minified/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <h1>QR → EAN-13 (сканер + генератор)</h1>

  <div class="card">
    <label for="cameraSelect">Выберите камеру:</label>
    <select id="cameraSelect"></select>
    <div class="controls">
      <button id="startBtn">Start camera</button>
      <button id="stopBtn" class="secondary">Stop</button>
    </div>
    <div id="reader" style="width:100%; max-width:420px; margin-top:12px;"></div>
    <div id="camStatus" class="small"></div>
  </div>

  <div class="card">
    <label>Извлечённый QR-текст:</label>
    <input id="rawText" type="text" readonly placeholder="Здесь появится содержимое QR" />
    <label>Цифры (будут использованы для EAN-13):</label>
    <input id="digitText" type="text" inputmode="numeric" pattern="[0-9]*" />
    <div class="controls">
      <button id="genBtn">Сгенерировать EAN-13</button>
      <button id="clearBtn" class="secondary">Очистить</button>
    </div>
    <div id="msg" class="small"></div>
  </div>

  <div class="card" id="resultCard" style="display:none;">
    <label>Результат EAN-13:</label>
    <input id="ean13" readonly style="font-weight:700;" />
    <svg id="barcode" width="320" height="140"></svg>
  </div>

<script>
function onlyDigits(s){return(s||'').replace(/\D/g,'');}
function calcCheckDigit(num){
  if(!/^[0-9]{12}$/.test(num))return null;
  let sum=0;
  for(let i=0;i<12;i++){sum+=parseInt(num[i])*((i%2)?3:1);}
  let mod=sum%10;
  return (mod===0)?'0':String(10-mod);
}
function showMsg(t,err=false){
  const el=document.getElementById('msg');
  el.textContent=t;
  el.className=err?'small danger':'small';
}

let html5QrCode=null;
let currentCam=null;

async function loadCameras(){
  const select=document.getElementById('cameraSelect');
  select.innerHTML='<option>Загрузка...</option>';
  try{
    const devices=await Html5Qrcode.getCameras();
    if(!devices.length){select.innerHTML='<option>Камеры не найдены</option>';return;}
    select.innerHTML='';
    devices.forEach((cam,i)=>{
      const opt=document.createElement('option');
      opt.value=cam.id; opt.textContent=cam.label||'Камера '+(i+1);
      select.appendChild(opt);
    });
    currentCam=devices[0].id;
  }catch(e){
    select.innerHTML='<option>Ошибка доступа к камере</option>';
  }
}

async function startCam(){
  const camId=document.getElementById('cameraSelect').value;
  if(!camId)return;
  if(!html5QrCode) html5QrCode=new Html5Qrcode("reader");
  try{
    document.getElementById('camStatus').textContent='Запуск камеры...';
    await html5QrCode.start(camId,{fps:10,qrbox:{width:300,height:300}},qr=>{
      document.getElementById('rawText').value=qr;
      document.getElementById('digitText').value=onlyDigits(qr);
      showMsg('QR распознан, готово к генерации.');
    });
    document.getElementById('camStatus').textContent='Камера запущена';
  }catch(e){
    document.getElementById('camStatus').innerHTML='<span class="danger">Ошибка: '+e+'</span>';
  }
}

async function stopCam(){
  if(html5QrCode){
    await html5QrCode.stop();
    html5QrCode.clear();
    html5QrCode=null;
    document.getElementById('camStatus').textContent='Камера остановлена';
  }
}

document.getElementById('startBtn').onclick=startCam;
document.getElementById('stopBtn').onclick=stopCam;
document.getElementById('cameraSelect').onchange=e=>{currentCam=e.target.value;};

document.getElementById('genBtn').onclick=()=>{
  const d=onlyDigits(document.getElementById('digitText').value);
  if(d.length<12){showMsg('Нужно минимум 12 цифр',true);return;}
  const code=d.slice(0,12)+calcCheckDigit(d.slice(0,12));
  JsBarcode("#barcode",code,{format:"ean13",displayValue:true,fontSize:18,width:2,height:80,margin:10});
  document.getElementById('ean13').value=code;
  document.getElementById('resultCard').style.display='block';
  showMsg('EAN-13 сгенерирован.');
};

document.getElementById('clearBtn').onclick=()=>{
  document.getElementById('rawText').value='';
  document.getElementById('digitText').value='';
  document.getElementById('msg').textContent='';
  document.getElementById('resultCard').style.display='none';
};

window.addEventListener('load',()=>{
  if(location.protocol==='file:'){
    document.getElementById('camStatus').innerHTML='<span class="danger">Открой через HTTPS: доступ к камере из file:// запрещён.</span>';
  } else {
    loadCameras();
  }
});
</script>
</body>
</html>
